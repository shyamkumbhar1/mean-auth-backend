name: Backend CI/CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          cp "full stack.pem" ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 56.228.81.214 >> ~/.ssh/known_hosts 2>/dev/null
          
          # Deploy
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@56.228.81.214 bash << EOF
            cd ~/mean-auth-app/backend
            git pull origin main
            
            cat > .env << 'ENVEOF'
          MONGODB_URI=mongodb+srv://shyamkumbhar509_db_user:6kUz4xLQGc2msUDz@mean-auth.ep0aggw.mongodb.net/mean-auth-dev
          JWT_SECRET=a9f3b8c2d1e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1
          JWT_EXPIRES_IN=7d
          ENVEOF
            chmod 600 .env
            
            docker stop backend 2>/dev/null || true
            docker rm backend 2>/dev/null || true
            
            export CONTAINER_NAME=backend
            export APP_PORT=3000
            export ENV_FILE=.env
            export NODE_ENV=production
            
            docker-compose up -d --build backend
            
            sleep 15
            docker ps | grep backend
            docker logs backend --tail=30
            
            # Health check from host (curl available on EC2)
            sleep 5
            for i in {1..5}; do
              if curl -f -s http://localhost:3000/ > /dev/null 2>&1; then
                echo "✅ Health check PASSED"
                exit 0
              fi
              echo "Attempt $i/5 failed, retrying..."
              sleep 5
            done
            echo "❌ Health check FAILED"
            docker logs backend --tail=50
            exit 1
          EOF
