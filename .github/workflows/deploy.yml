name: Backend CI/CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # Deploy
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash << EOF
            cd ~/mean-auth-app/backend
            git pull origin main
            
            echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}" >> .env
            chmod 600 .env
            
            docker stop backend 2>/dev/null || true
            docker rm backend 2>/dev/null || true
            
            export CONTAINER_NAME=backend
            export APP_PORT=3000
            export ENV_FILE=.env
            export NODE_ENV=production
            
            docker-compose up -d --build backend
            
            sleep 10
            docker exec backend curl -f -s http://localhost:3000/ > /dev/null || exit 1
          EOF