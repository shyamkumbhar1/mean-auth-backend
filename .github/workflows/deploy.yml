name: Backend CI/CD

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy Backend
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/mean-auth-app-backend
            git pull origin dev
            
            docker stop backend 2>/dev/null || true
            docker rm backend 2>/dev/null || true
            
            docker-compose up -d --build backend
            
            sleep 15
            docker logs backend --tail=30
          EOF
      
      - name: Health Check
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash << 'EOF'
            for i in {1..5}; do
              if docker exec backend curl -f -s http://localhost:3000/ > /dev/null; then
                echo "✅ Health check PASSED"
                exit 0
              fi
              sleep 5
            done
            echo "❌ Health check FAILED"
            docker logs backend --tail=30
            exit 1
          EOF