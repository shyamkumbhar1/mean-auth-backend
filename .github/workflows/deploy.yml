name: Backend CI/CD

on:
  push:
    branches: [dev, pre-prod]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set Environment
        id: env
        run: |
          set -x  # Enable verbose mode
          echo "üîç Detecting environment..."
          echo "Git ref: ${{ github.ref }}"
          
          if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            ENV="DEV"
            BRANCH="dev"
            CONTAINER="backend-dev"
            PORT="3001"
            ENV_FILE=".env.dev"
          else
            ENV="PRE_PROD"
            BRANCH="pre-prod"
            CONTAINER="backend-pre-prod"
            PORT="3002"
            ENV_FILE=".env.pre-prod"
          fi
          
          echo "‚úÖ Environment: $ENV"
          echo "‚úÖ Branch: $BRANCH"
          echo "‚úÖ Container: $CONTAINER"
          echo "‚úÖ Port: $PORT"
          echo "‚úÖ Env File: $ENV_FILE"
          
          echo "env=$ENV" >> $$GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $$GITHUB_OUTPUT
          echo "container=$CONTAINER" >> $$GITHUB_OUTPUT
          echo "port=$PORT" >> $$GITHUB_OUTPUT
          echo "env_file=$ENV_FILE" >> $$GITHUB_OUTPUT
      
      - name: Setup SSH
        run: |
          set -x  # Enable verbose mode
          echo "üîê Setting up SSH..."
          
          mkdir -p ~/.ssh
          ENV="${{ steps.env.outputs.env }}"
          
          if [ "$ENV" == "DEV" ]; then
            echo "Using DEV secrets"
            echo "${{ secrets.EC2_SSH_KEY_DEV }}" > ~/.ssh/deploy_key
            echo "${{ secrets.EC2_HOST_DEV }}" > /tmp/host.txt
            echo "${{ secrets.EC2_USER_DEV }}" > /tmp/user.txt
          else
            echo "Using PRE_PROD secrets"
            echo "${{ secrets.EC2_SSH_KEY_PRE_PROD }}" > ~/.ssh/deploy_key
            echo "${{ secrets.EC2_HOST_PRE_PROD }}" > /tmp/host.txt
            echo "${{ secrets.EC2_USER_PRE_PROD }}" > /tmp/user.txt
          fi
          
          chmod 600 ~/.ssh/deploy_key
          HOST=$(cat /tmp/host.txt)
          USER=$(cat /tmp/user.txt)
          
          echo "‚úÖ SSH Key: ~/.ssh/deploy_key"
          echo "‚úÖ Host: $HOST"
          echo "‚úÖ User: $USER"
          
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
          echo "‚úÖ SSH keyscan completed"
      
      - name: Create .env File
        run: |
          set -x  # Enable verbose mode
          echo "üìù Creating .env file..."
          
          ENV="${{ steps.env.outputs.env }}"
          HOST=$(cat /tmp/host.txt)
          USER=$(cat /tmp/user.txt)
          ENV_FILE="${{ steps.env.outputs.env_file }}"
          
          if [ "$ENV" == "DEV" ]; then
            MONGODB_URI="${{ secrets.MONGODB_URI_DEV }}"
            JWT_SECRET="${{ secrets.JWT_SECRET_DEV }}"
            JWT_EXPIRES_IN="${{ secrets.JWT_EXPIRES_IN_DEV }}"
          else
            MONGODB_URI="${{ secrets.MONGODB_URI_PRE_PROD }}"
            JWT_SECRET="${{ secrets.JWT_SECRET_PRE_PROD }}"
            JWT_EXPIRES_IN="${{ secrets.JWT_EXPIRES_IN_PRE_PROD }}"
          fi
          
          echo "‚úÖ Env File: $ENV_FILE"
          echo "‚úÖ MongoDB URI: ${MONGODB_URI:0:20}..." # Show first 20 chars only
          echo "‚úÖ JWT Secret: ${JWT_SECRET:0:10}..." # Show first 10 chars only
          echo "‚úÖ JWT Expires: $JWT_EXPIRES_IN"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -v $USER@$HOST bash -c "
            set -x
            cd ~/mean-auth-app/backend
            echo 'MONGODB_URI=$MONGODB_URI' > $ENV_FILE
            echo 'JWT_SECRET=$JWT_SECRET' >> $ENV_FILE
            echo 'JWT_EXPIRES_IN=$JWT_EXPIRES_IN' >> $ENV_FILE
            chmod 600 $ENV_FILE
            echo '‚úÖ .env file created'
            cat $ENV_FILE | sed 's/JWT_SECRET=.*/JWT_SECRET=***/' | sed 's/MONGODB_URI=.*/MONGODB_URI=***/'
          "
      
      - name: Deploy
        run: |
          set -x  # Enable verbose mode
          echo "üöÄ Starting deployment..."
          
          BRANCH="${{ steps.env.outputs.branch }}"
          CONTAINER="${{ steps.env.outputs.container }}"
          PORT="${{ steps.env.outputs.port }}"
          ENV_FILE="${{ steps.env.outputs.env_file }}"
          ENV="${{ steps.env.outputs.env }}"
          HOST=$(cat /tmp/host.txt)
          USER=$(cat /tmp/user.txt)
          
          echo "üìã Deployment Details:"
          echo "  Branch: $BRANCH"
          echo "  Container: $CONTAINER"
          echo "  Port: $PORT"
          echo "  Env File: $ENV_FILE"
          echo "  Environment: $ENV"
          echo "  Host: $HOST"
          echo "  User: $USER"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -v $USER@$HOST bash << 'EOF'
            set -x
            set -e
            
            echo "üìÇ Changing to project directory..."
            cd ~/mean-auth-app/backend
            pwd
            ls -la
            
            echo "üîÑ Pulling latest code..."
            git pull origin $BRANCH || {
              echo "‚ùå Git pull failed, trying checkout..."
              git fetch origin
              git checkout $BRANCH || git checkout -b $BRANCH origin/$BRANCH
              git pull origin $BRANCH
            }
            echo "‚úÖ Code updated"
            
            echo "üõë Stopping old containers..."
            docker stop $CONTAINER 2>/dev/null || echo "No container to stop"
            docker rm $CONTAINER 2>/dev/null || echo "No container to remove"
            
            echo "üîß Setting environment variables..."
            export CONTAINER_NAME=$CONTAINER
            export APP_PORT=$PORT
            export ENV_FILE=$ENV_FILE
            export NODE_ENV=$(echo $ENV | tr '[:upper:]' '[:lower:]')
            
            echo "  CONTAINER_NAME=$CONTAINER_NAME"
            echo "  APP_PORT=$APP_PORT"
            echo "  ENV_FILE=$ENV_FILE"
            echo "  NODE_ENV=$NODE_ENV"
            
            echo "üê≥ Building and starting container..."
            docker-compose up -d --build --force-recreate backend
            
            echo "‚è≥ Waiting for container to start..."
            sleep 15
            
            echo "üìä Container status:"
            docker ps | grep $CONTAINER || echo "‚ùå Container not running!"
            
            echo "üìã Container logs (last 50 lines):"
            docker logs $CONTAINER --tail=50 || echo "‚ùå Cannot get logs"
          EOF
      
      - name: Health Check
        run: |
          set -x  # Enable verbose mode
          echo "üè• Starting health check..."
          
          CONTAINER="${{ steps.env.outputs.container }}"
          HOST=$(cat /tmp/host.txt)
          USER=$(cat /tmp/user.txt)
          
          echo "  Container: $CONTAINER"
          echo "  Host: $HOST"
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -v $USER@$HOST bash << 'EOF'
            set -x
            
            echo "üîç Checking container status..."
            docker ps -a | grep $CONTAINER || echo "‚ùå Container not found"
            
            echo "üîç Checking if container is running..."
            if docker ps | grep -q $CONTAINER; then
              echo "‚úÖ Container is running"
            else
              echo "‚ùå Container is not running"
              echo "üìã Container logs:"
              docker logs $CONTAINER --tail=50 || true
              exit 1
            fi
            
            echo "üè• Running health checks..."
            for i in {1..5}; do
              echo "  Attempt $i/5..."
              if docker exec $CONTAINER curl -f -s -v http://localhost:3000/ > /tmp/health_response.txt 2>&1; then
                echo "‚úÖ Health check PASSED"
                cat /tmp/health_response.txt
                exit 0
              else
                echo "  ‚ùå Attempt $i failed"
                cat /tmp/health_response.txt || true
              fi
              [ $i -lt 5 ] && sleep 5
            done
            
            echo "‚ùå Health check FAILED after 5 attempts"
            echo "üìã Final container logs:"
            docker logs $CONTAINER --tail=50
            echo "üìã Container processes:"
            docker exec $CONTAINER ps aux || true
            exit 1
          EOF
