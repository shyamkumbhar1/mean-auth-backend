name: Backend CI/CD - Multi Environment

on:
  push:
    branches: [dev, pre-prod, prod]
  pull_request:
    types: [closed]
    branches: [pre-prod]
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target Environment'
        required: true
        type: choice
        options:
          - DEV
          - PRE_PROD
          - PROD

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Tests
        run: npm test || echo "No tests configured"
        continue-on-error: true
      
      - name: Build
        run: npm run build || echo "No build script"
        continue-on-error: true

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/prod')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'pre-prod') ||
      github.event_name == 'workflow_dispatch'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      
      - name: Determine Target Environment
        id: set_environment
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV_NAME="${{ github.event.inputs.target_environment }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            ENV_NAME="PRE_PROD"
          elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            ENV_NAME="DEV"
          elif [ "${{ github.ref }}" == "refs/heads/pre-prod" ]; then
            ENV_NAME="PRE_PROD"
          elif [ "${{ github.ref }}" == "refs/heads/prod" ]; then
            ENV_NAME="PROD"
          fi
          
          echo "environment_name=$ENV_NAME" >> $GITHUB_OUTPUT
          
          if [ "$ENV_NAME" == "DEV" ]; then
            echo "target_branch=dev" >> $GITHUB_OUTPUT
            echo "container_name=backend-dev" >> $GITHUB_OUTPUT
            echo "app_port=3001" >> $GITHUB_OUTPUT
            echo "secret_prefix=DEV" >> $GITHUB_OUTPUT
            echo "env_file=.env.dev" >> $GITHUB_OUTPUT
          elif [ "$ENV_NAME" == "PRE_PROD" ]; then
            echo "target_branch=pre-prod" >> $GITHUB_OUTPUT
            echo "container_name=backend-pre-prod" >> $GITHUB_OUTPUT
            echo "app_port=3002" >> $GITHUB_OUTPUT
            echo "secret_prefix=PRE_PROD" >> $GITHUB_OUTPUT
            echo "env_file=.env.pre-prod" >> $GITHUB_OUTPUT
          else
            echo "target_branch=prod" >> $GITHUB_OUTPUT
            echo "container_name=backend-prod" >> $GITHUB_OUTPUT
            echo "app_port=3000" >> $GITHUB_OUTPUT
            echo "secret_prefix=PROD" >> $GITHUB_OUTPUT
            echo "env_file=.env.prod" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          ENV_PREFIX="${{ steps.set_environment.outputs.secret_prefix }}"
          
          if [ "$ENV_PREFIX" == "DEV" ]; then
            echo "${{ secrets.EC2_SSH_KEY_DEV }}" > ~/.ssh/deploy_key
            echo "${{ secrets.EC2_HOST_DEV }}" > /tmp/ec2_host.txt
            echo "${{ secrets.EC2_USER_DEV }}" > /tmp/ec2_user.txt
          elif [ "$ENV_PREFIX" == "PRE_PROD" ]; then
            echo "${{ secrets.EC2_SSH_KEY_PRE_PROD }}" > ~/.ssh/deploy_key
            echo "${{ secrets.EC2_HOST_PRE_PROD }}" > /tmp/ec2_host.txt
            echo "${{ secrets.EC2_USER_PRE_PROD }}" > /tmp/ec2_user.txt
          else
            echo "${{ secrets.EC2_SSH_KEY_PROD }}" > ~/.ssh/deploy_key
            echo "${{ secrets.EC2_HOST_PROD }}" > /tmp/ec2_host.txt
            echo "${{ secrets.EC2_USER_PROD }}" > /tmp/ec2_user.txt
          fi
          
          chmod 600 ~/.ssh/deploy_key
          EC2_HOST=$(cat /tmp/ec2_host.txt)
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
      
      - name: Create .env File on EC2
        run: |
          ENV_PREFIX="${{ steps.set_environment.outputs.secret_prefix }}"
          ENV_FILE="${{ steps.set_environment.outputs.env_file }}"
          EC2_HOST=$(cat /tmp/ec2_host.txt)
          EC2_USER=$(cat /tmp/ec2_user.txt)
          
          if [ "$ENV_PREFIX" == "DEV" ]; then
            MONGODB_URI="${{ secrets.MONGODB_URI_DEV }}"
            JWT_SECRET="${{ secrets.JWT_SECRET_DEV }}"
            JWT_EXPIRES_IN="${{ secrets.JWT_EXPIRES_IN_DEV }}"
          elif [ "$ENV_PREFIX" == "PRE_PROD" ]; then
            MONGODB_URI="${{ secrets.MONGODB_URI_PRE_PROD }}"
            JWT_SECRET="${{ secrets.JWT_SECRET_PRE_PROD }}"
            JWT_EXPIRES_IN="${{ secrets.JWT_EXPIRES_IN_PRE_PROD }}"
          else
            MONGODB_URI="${{ secrets.MONGODB_URI_PROD }}"
            JWT_SECRET="${{ secrets.JWT_SECRET_PROD }}"
            JWT_EXPIRES_IN="${{ secrets.JWT_EXPIRES_IN_PROD }}"
          fi
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST bash -c "
            cd ~/mean-auth-app
            cat > $ENV_FILE << 'ENVEOF'
          MONGODB_URI=$MONGODB_URI
          JWT_SECRET=$JWT_SECRET
          JWT_EXPIRES_IN=$JWT_EXPIRES_IN
          ENVEOF
            chmod 600 $ENV_FILE
          "
      
      - name: Deploy Backend
        run: |
          ENV_NAME="${{ steps.set_environment.outputs.environment_name }}"
          TARGET_BRANCH="${{ steps.set_environment.outputs.target_branch }}"
          CONTAINER_NAME="${{ steps.set_environment.outputs.container_name }}"
          APP_PORT="${{ steps.set_environment.outputs.app_port }}"
          EC2_HOST=$(cat /tmp/ec2_host.txt)
          EC2_USER=$(cat /tmp/ec2_user.txt)
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            cd ~/mean-auth-app/backend
            git fetch origin
            git checkout $TARGET_BRANCH 2>/dev/null || git checkout -b $TARGET_BRANCH origin/$TARGET_BRANCH
            git pull origin $TARGET_BRANCH
            cd ~/mean-auth-app
            docker-compose -f backend/docker-compose.yml up -d --build backend
            sleep 10
            docker-compose -f backend/docker-compose.yml ps
            docker-compose -f backend/docker-compose.yml logs --tail=50 backend
          ENDSSH
      
      - name: Health Check
        run: |
          APP_PORT="${{ steps.set_environment.outputs.app_port }}"
          EC2_HOST=$(cat /tmp/ec2_host.txt)
          
          sleep 30
          for i in {1..5}; do
            if curl -f -s http://$EC2_HOST:$APP_PORT/health || curl -f -s http://$EC2_HOST:$APP_PORT/ > /dev/null; then
              echo "✅ Health check PASSED"
              exit 0
            fi
            sleep 5
          done
          echo "❌ Health check FAILED"
          exit 1